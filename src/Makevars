# Makevars for acediaR package
# Configures compilation of C++ and CUDA source files

# Detect R installation  
R_HOME = $(shell R RHOME)

# CUDA installation path
CUDA_HOME ?= /usr/local/cuda
CUDA_LIB_PATH = $(CUDA_HOME)/lib64

# C++ compiler flags (include Rcpp)
PKG_CPPFLAGS = -I$(R_HOME)/include -I$(CUDA_HOME)/include $(shell $(R_HOME)/bin/Rscript -e "Rcpp:::CxxFlags()") -D_FORTIFY_SOURCE=2 -fPIC

# Linker flags  
PKG_LIBS = -L$(R_HOME)/lib -lR -L$(CUDA_LIB_PATH) -lcudart $(shell $(R_HOME)/bin/Rscript -e "Rcpp:::LdFlags()")

# CUDA compiler and flags  
NVCC = $(CUDA_HOME)/bin/nvcc
NVCCFLAGS = -O3 -arch=sm_89 --ptxas-options=-v -c -Xcompiler -fPIC

# Define source and object files
CUDA_SOURCES = $(wildcard *.cu)
CUDA_OBJECTS = $(CUDA_SOURCES:.cu=.o)
CPP_SOURCES = $(wildcard *.cpp)
CPP_OBJECTS = $(CPP_SOURCES:.cpp=.o)

# Include all objects in the build
OBJECTS = R_interface.o RcppInterface.o RcppExports.o vector_add.o

# Rules for CUDA compilation
%.o: %.cu
	$(NVCC) $(NVCCFLAGS) -I$(R_HOME)/include $< -o $@

# Make sure all objects are built before creating shared library
$(SHLIB): $(OBJECTS) 